<html>
    <head>
        <title>APIテスト</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script src="./properties.js"></script>
        <script>
            //各csvのデータの個数
            var csv_item_list = [];

            //ファイル名
            let file_name = "";
            //ファイル番号
            let file_num = "0";
            //問題番号
            let question_num = "0";
            //問題文
            let sentense = ""
            //答え
            let quiz_answer = ""

            //ファイル名、ファイル番号の変更を反映する
            function update_file_num(event){
                fl = document.getElementById("file_list")
                file_num = Number(fl.options[fl.selectedIndex].value)
                file_name = fl.options[fl.selectedIndex].innerText
            }

            //問題番号の変更を反映する
            function update_question_num(event){
                question_num = Number(document.getElementById("question_number").value)
            }

            //エラーメッセージの設定・表示
            function set_error_message(msg){
                err = document.getElementById("error")
                err.innerText = msg
            }

            //エラーメッセージのクリア
            function clear_error_message(){
                err = document.getElementById("error")
                err.innerText = ""
            }

            //エラーチェック①,入力した問題番号がcsvにある問題番号の範囲内か調べる
            function check_input_question_num(file_index){
                if(question_num < 1 || csv_item_list[file_index] < question_num ){
                    return true
                }else{
                    return false
                }
            }

            //問題csvのリストを取得する
            function get_csv_name_list(){
                //エラーメッセージをクリア
                clear_error_message();

                //XMLHttpRequest用意
                var xhr = new XMLHttpRequest();
                
                xhr.open('POST', getCsvNameListApi());
                xhr.setRequestHeader('Content-type', 'application/json;charset=UTF-8');
                //JSONデータ作成
                var data = {
                    "text" : ''
                }
                //送信
                xhr.send( JSON.stringify(data) );

                //受信して結果を表示
                xhr.onreadystatechange = function() {
                    if(xhr.readyState === 4 && xhr.status === 200) {
                        const text = JSON.parse(xhr.responseText);      
                        // ドロップダウンリストにCSVファイルのリストを定義
                        let file_list = document.getElementById("file_list");
                        for(var i=0;i<text['text'].length;i++){
                            var target = document.createElement('option');
                            target.innerText = text['text'][i];
                            target.setAttribute('value',i);
                            file_list.appendChild(target);
                            csv_item_list.push(text['item'][i])
                        }
                    }
                }
            }

            function ajax_post(url){
                //エラーメッセージをクリア
                clear_error_message();
                
                //エラーチェック、問題番号が範囲内か
                if(check_input_question_num(file_num)){
                    set_error_message("エラー：問題("+file_name
                                        +")の問題番号は1〜"+csv_item_list[file_num]
                                        +"の範囲内で入力して下さい");
                    return false;
                }

                //XMLHttpRequest用意
                var xhr = new XMLHttpRequest();
    
                xhr.open('POST', url);
                xhr.setRequestHeader('content-type', 'application/json;charset=UTF-8');
                //JSONデータ作成
                var data = {
                    "text" : String(file_num)+'-'+String(question_num)
                }
                //送信
                xhr.send( JSON.stringify(data) );

                //受信して結果を表示
                xhr.onreadystatechange = function() {
                    if(xhr.readyState === 4 && xhr.status === 200) {
                        const jsonObj = JSON.parse(xhr.responseText);      

                        let question = document.getElementById("question")
                        let answer = document.getElementById("answer")
                        sentense = jsonObj.sentense
                        quiz_answer =  jsonObj.answer

                        question.textContent = sentense
                        answer.textContent = ""
                    }
                }
            }

            window.onload = function(){
                get_csv_name_list();
            };

            //答えの文を表示
            function display_answer(){
                let answer = document.getElementById("answer")
                answer.textContent = quiz_answer
            }
        </script>
    </head>
<body>
    <h1>CSV Quiz Bot</h1>

    <p id="error" style="color:red"></p>

    <table style="border:none">
        <tr>
            <td>ファイル</td>
            <td>:</td>
            <td>
                <select id="file_list" onChange="update_file_num(event)">
                    <option selected value="-1">指定なし</option>
                </select>
            </td>
        </tr>
        <tr>
            <td>問題番号</td>
            <td>:</td>
            <td><input type="text" id="question_number" onChange="update_question_num(event)"></td>
        </tr>
    </table>
    <input type="button" value="送信" onClick="ajax_post(getQuestionApi())">

    <hr>
    <span>問題：</span>
    <span id="question"></span>
    <hr>
    <input type="button" value="答え" onClick="display_answer()">

    <div id="answer"></div>

    <input type="button" value="正解！" onClick="ajax_post(getCorrectRegisterApi())" >
    <input type="button" value="不正解" onClick="ajax_post(getIncorrectRegisterApi())">

</body>
</html>

